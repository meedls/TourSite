{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TravelHub - Создай своё путешествие{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Стили для header с улучшенной видимостью */
        .header {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        .header .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
            position: relative;
        }
        .header .logo {
            flex-shrink: 0;
        }
        .header .logo-img {
            height: 40px;
        }
        .header .nav-menu {
            display: flex;
            list-style: none;
            gap: 30px;
            margin: 0;
            padding: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        .header .nav > div:last-of-type {
            flex-shrink: 0;
            margin-left: auto;
        }
        .header .btn-login {
            white-space: nowrap;
        }
        .header .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s;
        }
        .header .nav-link:hover {
            color: #3498db;
        }
        .header .btn-login {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 12px 28px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 700;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid #1a237e;
            box-shadow: 0 10px 24px rgba(26,35,126,0.18);
        }
        .header .btn-login:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 26px rgba(26,35,126,0.22);
        }
        .header .nav-line {
            display: none;
        }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    {% block body_background %}{% endblock %}

    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">
                    <a href="{% url 'tours:index' %}">
                        <img src="{% static 'images/Group 2.svg' %}" alt="TravelHub Logo" class="logo-img">
                    </a>
                </div>

                <ul class="nav-menu">
                    <li><a href="{% url 'tours:index' %}" class="nav-link">Главная</a></li>
                    <li>
                        <a href="{% url 'tours:tour_create' %}" class="nav-link"
                           {% if not user.is_authenticated %}data-requires-auth="true"{% endif %}>
                            Туры
                        </a>
                    </li>
                    {% if user.is_authenticated %}
                        <li><a href="#" class="nav-link open-friends-modal">Друзья</a></li>
                        <li><a href="#" class="nav-link open-profile-modal">Профиль</a></li>
                    {% else %}
                        <li><a href="#" class="nav-link open-friends-modal" data-requires-auth="true">Друзья</a></li>
                    {% endif %}
                </ul>

                <div>
                    {% if not user.is_authenticated %}
                        <a href="{% url 'users:login' %}" class="btn-login open-auth-modal" data-mode="login">Вход</a>
                    {% endif %}
                </div>
                <div class="nav-line"></div>
            </nav>
        </div>
    </header>

    <main class="main">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-left">
                    <div class="footer-logo">
                        <img src="{% static 'images/Group 2.svg' %}" alt="TravelHub Logo" class="footer-logo-img">
                    </div>
                </div>

                <div class="footer-center">
                    <div class="footer-info">
                        <h3 class="footer-category">ИНФОРМАЦИЯ</h3>
                        <ul class="footer-links">
                            <li><a href="#" class="footer-link">О нас</a></li>
                            <li><a href="{% url 'tours:tour_list' %}" class="footer-link">Готовые туры</a></li>
                            {% if user.is_authenticated %}
                                <li><a href="{% url 'users:profile' %}" class="footer-link">Профиль</a></li>
                            {% endif %}
                            <li><a href="{% url 'hotels:hotel_list' %}" class="footer-link">Отели и билеты</a></li>
                        </ul>
                    </div>
                </div>

                <div class="footer-right">
                    <div class="footer-contacts">
                        <h3 class="footer-category">КОНТАКТЫ</h3>
                        <ul class="footer-links">
                            <li><a href="mailto:journey@gmail.ru" class="footer-link">journey@gmail.ru</a></li>
                            <li><a href="tel:88000003555" class="footer-link">8 800 000 35 55</a></li>
                        </ul>
                    </div>

                    <div class="footer-social">
                        <h3 class="footer-category">МЫ В ИНТЕРНЕТЕ</h3>
                        <div class="social-icons">
                            <a href="#" class="social-icon"><i class="fab fa-vk"></i></a>
                            <a href="#" class="social-icon"><i class="fab fa-telegram"></i></a>
                            <a href="#" class="social-icon"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    </div>

                    <div class="footer-copyright">
                        <p>Все права защищены 2025 ©</p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Friends list modal -->
    <div class="friends-overlay" style="display:none;">
        <div class="friends-modal">
            <button class="auth-close friends-close" type="button">&times;</button>
            <h3 class="friends-title">Друзья</h3>
            <div class="friends-search">
                <input type="text" placeholder="Поиск по имени..." class="friends-search-input">
                <button type="button" class="friends-search-btn">Найти</button>
            </div>
            <div class="friends-list" id="friends-list"></div>
        </div>
    </div>

    <!-- Friend detail modal -->
    <div class="friend-detail-overlay" style="display:none;">
        <div class="friend-detail-modal">
            <button class="auth-close friend-detail-close" type="button">&times;</button>
            <div class="friend-detail-body">
                <div class="friend-avatar-big"><i class="fas fa-user-circle"></i></div>
                <div class="friend-detail-name" id="friend-name"></div>
                <div class="friend-detail-username" id="friend-username"></div>
                <div class="friend-detail-date" id="friend-date"></div>
                <a class="friend-subscribe-btn" id="friend-subscribe" href="#" data-friend-id="">Подписаться</a>
            </div>
        </div>
    </div>

    <!-- Profile modal -->
    <div class="profile-overlay" style="display:none;">
        <div class="profile-modal">
            <button class="auth-close profile-close" type="button">&times;</button>

            <div class="profile-container">
                <div class="profile-header">
                    <div class="profile-info">
                        <div class="avatar"><i class="fas fa-user-circle"></i></div>
                        <div class="user-details">
                            <h1 class="user-name profile-user-name">—</h1>
                            <p class="user-id profile-user-id">ID: —</p>
                        </div>
                    </div>
                    <div class="settings">
                        <button class="settings-btn" type="button"><i class="fas fa-cog"></i></button>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <h2 class="section-title">Путешествия</h2>
                        <div class="bookings-header">
                            <h3 class="subsection-title">Мои бронирования <span class="count">(0)</span></h3>
                            <button class="details-btn" type="button">Подробнее</button>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <div class="info-item">
                        <div class="info-content">
                            <h3>Способ оплаты</h3>
                        </div>
                        <button class="arrow-btn" type="button"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="info-item">
                        <div class="info-content">
                            <h3>Избранные города <span class="count">(0)</span></h3>
                        </div>
                        <button class="arrow-btn" type="button"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="divider-after-cities"></div>

                <div class="section">
                    <h2 class="section-title">Мои друзья</h2>
                    <div class="info-item">
                        <div class="info-content">
                            <h3>Друзья <span class="count">(0)</span></h3>
                        </div>
                        <button class="arrow-btn" type="button"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="info-item">
                        <div class="info-content">
                            <h3>Подписчики <span class="count">(0)</span></h3>
                        </div>
                        <button class="arrow-btn" type="button"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>

                <div class="divider-after-subscribers"></div>

                <div class="logout-section">
                    <a class="logout-btn open-logout-modal" href="#">Выход</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout modal -->
    <div class="logout-overlay modal-overlay" style="display:none;">
        <div class="logout-modal">
            <div class="logout-panel">
                <div class="logout-title">Выйти из аккаунта</div>
                <div class="buttons-container">
                    <button class="btn btn-yes" id="logout-yes">Да</button>
                    <button class="btn btn-cancel" id="logout-cancel">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Edit modal -->
    <div class="profile-edit-overlay" style="display:none;">
        <div class="profile-edit-modal">
            <button class="profile-edit-close" type="button">&times;</button>
            <h2 class="profile-edit-title">Редактировать профиль</h2>
            <form class="profile-form">
                <div class="form-group">
                    <label>Логин</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Имя</label>
                    <input type="text" name="first_name">
                </div>
                <div class="form-group">
                    <label>Фамилия</label>
                    <input type="text" name="last_name">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <button type="submit" class="auth-submit">Сохранить</button>
            </form>
        </div>
    </div>

    <!-- Auth modal -->
    <div class="auth-overlay" style="display:none;">
        <div class="auth-modal">
            <button class="auth-close" type="button">&times;</button>
            <div class="auth-tabs">
                <button type="button" class="auth-tab active" data-mode="login">Вход</button>
                <button type="button" class="auth-tab" data-mode="register">Регистрация</button>
            </div>

            <form class="auth-form auth-login-form" method="post" action="{% url 'users:login' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label>Имя пользователя</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit" class="auth-submit">Войти</button>
            </form>

            <form class="auth-form auth-register-form" method="post" action="{% url 'users:register' %}" style="display:none;">
                {% csrf_token %}
                <div class="form-group">
                    <label>Имя пользователя</label>
                    <input type="text" name="username" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Пароль</label>
                    <input type="password" name="password1" required>
                </div>
                <div class="form-group">
                    <label>Подтверждение пароля</label>
                    <input type="password" name="password2" required>
                </div>
                <button type="submit" class="auth-submit">Зарегистрироваться</button>
            </form>
        </div>
    </div>

    <style>
        .auth-overlay,
        .friends-overlay,
        .friend-detail-overlay,
        .profile-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .auth-modal {
            background: #fff;
            border-radius: 24px;
            padding: 26px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            position: relative;
        }
        .auth-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: #f5f7fa;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
            z-index: 10;
        }
        .auth-close:hover {
            background: #e9ecef;
            color: #333;
        }
        .auth-tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }
        .auth-tab {
            padding: 10px;
            border-radius: 12px;
            border: 1px solid #dce0e5;
            background: #f5f7fa;
            cursor: pointer;
            font-weight: 700;
            color: #1a237e;
        }
        .auth-tab.active {
            background: #1a237e;
            color: #fff;
            border-color: #1a237e;
        }
        .auth-form .form-group {
            margin-bottom: 14px;
        }
        .auth-form label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        .auth-form input {
            width: 100%;
            padding: 11px 12px;
            border: 1px solid #dcdfe5;
            border-radius: 12px;
            font-size: 14px;
            transition: border 0.2s ease;
        }
        .auth-form input:focus {
            outline: none;
            border-color: #1a237e;
            box-shadow: 0 0 0 2px rgba(26,35,126,0.1);
        }
        .auth-submit {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            margin-top: 4px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .auth-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(26,35,126,0.22);
        }

    /* Friends modals */
    .friends-modal, .friend-detail-modal {
        background: #fff;
        border-radius: 18px;
        padding: 18px;
        width: 100%;
        max-width: 520px;
        box-shadow: 0 16px 40px rgba(0,0,0,0.2);
        position: relative;
    }
    .friends-title {
        margin: 0 0 12px 0;
        font-size: 20px;
        font-weight: 700;
        color: #1a237e;
    }
    .friends-search {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }
    .friends-search-input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #dcdfe5;
        font-size: 14px;
    }
    .friends-search-btn {
        padding: 10px 14px;
        border: none;
        border-radius: 12px;
        background: #1a237e;
        color: #fff;
        font-weight: 700;
        cursor: pointer;
    }
    .friends-list {
        max-height: 320px;
        overflow: auto;
        border: 1px solid #eef0f4;
        border-radius: 12px;
    }
    .friend-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        border-bottom: 1px solid #f2f3f6;
    }
    .friend-row:last-child { border-bottom: none; }
    .friend-row .name {
        font-weight: 600;
        color: #333;
    }
    .friend-row .username {
        color: #777;
        font-size: 13px;
    }
    .friend-row button {
        border: none;
        background: #1a237e;
        color: #fff;
        padding: 8px 10px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
    }
    .friend-detail-modal {
        max-width: 400px;
        text-align: center;
    }
    .friend-avatar-big {
        font-size: 72px;
        color: #1a237e;
        margin-bottom: 12px;
    }
    .friend-detail-name {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 6px;
    }
    .friend-detail-username {
        color: #666;
        margin-bottom: 6px;
    }
    .friend-detail-date {
        color: #888;
        margin-bottom: 12px;
    }
    .friend-subscribe-btn {
        display: inline-block;
        padding: 10px 14px;
        background: #1a237e;
        color: #fff;
        border-radius: 12px;
        font-weight: 700;
        text-decoration: none;
    }
        .profile-modal {
            background: #fff;
            border-radius: 18px;
            padding: 20px;
            width: 100%;
            max-width: 520px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.2);
            position: relative;
        }
        .profile-container {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            padding: 24px;
            position: relative;
            padding-bottom: 70px;
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 25px;
        }
        .profile-info {
            display: flex;
            align-items: flex-start;
        }
        .avatar { margin-right: 16px; }
        .avatar i { font-size: 64px; color: #4a6cf7; }
        .user-details h1 { font-size: 22px; color: #333; margin-bottom: 4px; }
        .user-details p { font-size: 14px; color: #777; }
        .settings-btn {
            background: none;
            border: none;
            font-size: 22px;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .settings-btn:hover { background-color: #f0f0f0; }
        .section { margin-bottom: 18px; }
        .section-title { font-size: 20px; color: #333; margin-bottom: 12px; }
        .subsection-title { font-size: 16px; color: #555; font-weight: 600; margin: 0; }
        .bookings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .count { color: #4a6cf7; font-weight: 600; }
        .details-btn {
            background-color: #141937;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .details-btn:hover { background-color: #3a5ce5; }
        .info-section { margin-bottom: 8px; }
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
        }
        .info-content h3 { font-size: 16px; color: #444; font-weight: 600; margin: 0; }
        .arrow-btn {
            background: none;
            border: none;
            font-size: 16px;
            color: #999;
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        .arrow-btn:hover { background-color: #f0f0f0; color: #666; }
        .divider-after-cities,
        .divider-after-subscribers {
            height: 1px;
            background-color: #e0e0e0;
            margin: 8px 0 18px 0;
        }
        .logout-section {
            position: absolute;
            bottom: 24px;
            left: 24px;
        }
        .logout-btn {
            display: inline-block;
            background-color: #141937;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(74, 108, 247, 0.3);
        }
        .logout-btn:hover {
            background-color: #3a5ce5;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 108, 247, 0.4);
        }
        .profile-edit-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .profile-edit-modal {
            background: #fff;
            border-radius: 28px;
            padding: 32px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 24px 64px rgba(0,0,0,0.3);
            position: relative;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .profile-edit-close {
            position: absolute;
            top: 16px;
            right: 16px;
            border: none;
            background: #f5f7fa;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
        }
        .profile-edit-close:hover {
            background: #e9ecef;
            color: #333;
            transform: rotate(90deg);
        }
        .profile-edit-title {
            font-size: 26px;
            font-weight: 700;
            color: #1a237e;
            margin-bottom: 8px;
            margin-top: 8px;
        }
        .profile-form {
            margin-top: 24px;
        }
        .profile-form .form-group {
            margin-bottom: 20px;
        }
        .profile-form label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #1a237e;
            letter-spacing: 0.3px;
        }
        .profile-form input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e4e8;
            border-radius: 14px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: #fafbfc;
            box-sizing: border-box;
        }
        .profile-form input:focus {
            outline: none;
            border-color: #1a237e;
            background: #fff;
            box-shadow: 0 0 0 4px rgba(26, 35, 126, 0.1);
        }
        .profile-form input:hover {
            border-color: #c5cae9;
        }
        .profile-form .auth-submit {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(26, 35, 126, 0.3);
        }
        .profile-form .auth-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(26, 35, 126, 0.4);
        }
        .profile-form .auth-submit:active {
            transform: translateY(0);
        }

        /* Logout modal */
        .logout-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .logout-modal {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logout-panel {
            background: white;
            border-radius: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
            width: 300px;
            padding: 25px;
            text-align: center;
        }
        .logout-title {
            font-size: 17px;
            font-weight: 600;
            color: #333;
            margin-bottom: 22px;
        }
        .buttons-container {
            text-align: center;
        }
        .btn {
            border: none;
            border-radius: 15px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-block;
        }
        .btn-yes {
            background-color: #141937;
            color: white;
            padding: 8px 25px;
            min-height: 36px;
            width: 80px;
            margin-right: 10px;
        }
        .btn-yes:hover {
            background-color: #0d1125;
        }
        .btn-cancel {
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 20px;
            min-height: 36px;
            width: 100px;
        }
        .btn-cancel:hover {
            background-color: #e0e0e0;
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const isAuth = '{{ user.is_authenticated|yesno:"true,false" }}' === 'true';
            const overlay = document.querySelector('.auth-overlay');
            const tabs = document.querySelectorAll('.auth-tab');
            const forms = {
                login: document.querySelector('.auth-login-form'),
                register: document.querySelector('.auth-register-form')
            };

            const switchMode = (mode) => {
                tabs.forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
                forms.login.style.display = mode === 'login' ? 'block' : 'none';
                forms.register.style.display = mode === 'register' ? 'block' : 'none';
            };

            tabs.forEach(tab => tab.addEventListener('click', () => switchMode(tab.dataset.mode)));

            const openAuth = (mode='login') => {
                if (!overlay) return;
                switchMode(mode);
                overlay.style.display = 'flex';
            };

            document.querySelectorAll('.open-auth-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const mode = btn.dataset.mode || 'login';
                    openAuth(mode);
                });
            });

            document.querySelector('.auth-close')?.addEventListener('click', () => overlay.style.display = 'none');
            overlay?.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.style.display = 'none';
            });

            // Перехват кликов по элементам, требующим авторизацию
            document.querySelectorAll('[data-requires-auth]').forEach(el => {
                el.addEventListener('click', (e) => {
                    if (isAuth) return;
                    e.preventDefault();
                    const mode = el.dataset.mode || 'login';
                    openAuth(mode);
                });
            });

            // Friends modal
            const friendsOverlay = document.querySelector('.friends-overlay');
            const friendDetailOverlay = document.querySelector('.friend-detail-overlay');
            const friendsListEl = document.getElementById('friends-list');
            const searchInput = document.querySelector('.friends-search-input');
            const searchBtn = document.querySelector('.friends-search-btn');

            const closeFriends = () => friendsOverlay.style.display = 'none';
            const closeFriendDetail = () => friendDetailOverlay.style.display = 'none';
            const profileOverlay = document.querySelector('.profile-overlay');
            const profileEditOverlay = document.querySelector('.profile-edit-overlay');
            const profileForm = document.querySelector('.profile-form');
            const profileNameEl = document.querySelector('.profile-user-name');
            const profileIdEl = document.querySelector('.profile-user-id');
            const closeProfile = () => profileOverlay.style.display = 'none';
            const closeProfileEdit = () => profileEditOverlay.style.display = 'none';

            document.querySelector('.friends-close')?.addEventListener('click', closeFriends);
            friendsOverlay?.addEventListener('click', (e) => { if (e.target === friendsOverlay) closeFriends(); });
            document.querySelector('.friend-detail-close')?.addEventListener('click', closeFriendDetail);
            friendDetailOverlay?.addEventListener('click', (e) => { if (e.target === friendDetailOverlay) closeFriendDetail(); });
            document.querySelector('.profile-close')?.addEventListener('click', closeProfile);
            profileOverlay?.addEventListener('click', (e) => { if (e.target === profileOverlay) closeProfile(); });
            document.querySelector('.profile-edit-close')?.addEventListener('click', closeProfileEdit);
            profileEditOverlay?.addEventListener('click', (e) => { if (e.target === profileEditOverlay) closeProfileEdit(); });

            const openFriendDetail = (id) => {
                fetch(`{% url 'users:api_user_detail' pk=0 %}`.replace('/0/', `/${id}/`))
                    .then(r => r.json())
                    .then(u => {
                        document.getElementById('friend-name').textContent = (u.first_name || u.last_name) ? `${u.first_name} ${u.last_name}`.trim() : u.username;
                        document.getElementById('friend-username').textContent = `@${u.username}`;
                        document.getElementById('friend-date').textContent = u.date_joined ? `С нами с ${u.date_joined}` : '';
                        const sub = document.getElementById('friend-subscribe');
                        sub.dataset.friendId = u.id;
                        sub.href = `{% url 'users:friend_add' user_id=0 %}`.replace('/0/', `/${u.id}/`);
                        friendDetailOverlay.style.display = 'flex';
                    });
            };

            const renderFriends = (users=[]) => {
                friendsListEl.innerHTML = '';
                users.forEach(u => {
                    const row = document.createElement('div');
                    row.className = 'friend-row';
                    row.innerHTML = `
                        <div>
                            <div class="name">${u.first_name || u.last_name ? (u.first_name + ' ' + u.last_name).trim() : u.username}</div>
                            <div class="username">@${u.username}</div>
                        </div>
                        <button type="button" data-id="${u.id}">Открыть</button>
                    `;
                    row.querySelector('button').addEventListener('click', () => openFriendDetail(u.id));
                    friendsListEl.appendChild(row);
                });
            };

            const fetchFriends = (q='') => {
                fetch(`{% url 'users:api_users' %}?q=${encodeURIComponent(q)}`)
                    .then(r => r.json())
                    .then(data => renderFriends(data.users || []));
            };

            const openFriendsModal = () => {
                if (!isAuth) {
                    openAuth('login');
                    return;
                }
                friendsOverlay.style.display = 'flex';
                fetchFriends('');
            };

            document.querySelectorAll('.open-friends-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openFriendsModal();
                });
            });

            searchBtn?.addEventListener('click', () => fetchFriends(searchInput.value || ''));

            // Профиль
            const getCSRF = () => {
                const match = document.cookie.match(/csrftoken=([^;]+)/);
                return match ? match[1] : '';
            };
            const fillProfile = (data) => {
                if (profileNameEl) profileNameEl.textContent = (data.first_name || data.last_name) ? `${data.first_name || ''} ${data.last_name || ''}`.trim() : (data.username || '');
                if (profileIdEl) profileIdEl.textContent = data.id ? `ID: ${data.id}` : 'ID: —';
            };
            const fillProfileEdit = (data) => {
                if (!profileForm) return;
                profileForm.username.value = data.username || '';
                profileForm.first_name.value = data.first_name || '';
                profileForm.last_name.value = data.last_name || '';
                profileForm.email.value = data.email || '';
            };
            const openProfile = () => {
                if (!isAuth) {
                    openAuth('login');
                    return;
                }
                fetch("{% url 'users:api_profile' %}")
                    .then(r => r.json())
                    .then(data => {
                        fillProfile(data);
                        profileOverlay.style.display = 'flex';
                    });
            };
            const openProfileEdit = () => {
                if (!isAuth) {
                    openAuth('login');
                    return;
                }
                fetch("{% url 'users:api_profile' %}")
                    .then(r => r.json())
                    .then(data => {
                        fillProfileEdit(data);
                        profileEditOverlay.style.display = 'flex';
                    });
            };
            document.querySelectorAll('.open-profile-modal').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openProfile();
                });
            });
            document.querySelector('.settings-btn')?.addEventListener('click', (e) => {
                e.preventDefault();
                openProfileEdit();
            });
            profileForm?.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = new FormData(profileForm);
                fetch("{% url 'users:api_profile' %}", {
                    method: 'POST',
                    headers: {'X-CSRFToken': getCSRF()},
                    body: formData
                }).then(r => r.json()).then((data) => {
                    fillProfile(data);
                    closeProfileEdit();
                });
            });
        });

        // Logout modal
        const logoutOverlay = document.querySelector('.logout-overlay');
        const logoutYesBtn = document.getElementById('logout-yes');
        const logoutCancelBtn = document.getElementById('logout-cancel');

        const openLogoutModal = () => {
            if (logoutOverlay) {
                logoutOverlay.style.display = 'flex';
            }
        };

        const closeLogoutModal = () => {
            if (logoutOverlay) {
                logoutOverlay.style.display = 'none';
            }
        };

        document.querySelectorAll('.open-logout-modal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openLogoutModal();
            });
        });

        logoutCancelBtn?.addEventListener('click', closeLogoutModal);
        logoutOverlay?.addEventListener('click', (e) => {
            if (e.target === logoutOverlay) closeLogoutModal();
        });

        logoutYesBtn?.addEventListener('click', () => {
            window.location.href = "{% url 'users:logout' %}";
        });
    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>
